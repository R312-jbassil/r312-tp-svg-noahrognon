---
if (Astro.locals.user) {
    return Astro.redirect('/');
}
---

<html lang="en" data-theme="light" class="h-full">
    <head>
        <title>Sign Up</title>
        <meta name="viewport" content="width=device-width" />
        <link
            href="https://cdn.jsdelivr.net/npm/daisyui@3.8.0/dist/full.css"
            rel="stylesheet"
            type="text/css"
        />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="auth-page">
        <div class="auth-overlay"></div>
        <div class="auth-card">
            <section class="auth-card__aside auth-card__aside--signup">
                    <header>
                        <p class="auth-eyebrow">Rejoins la communaute</p>
                        <h1 class="auth-title">Cree ton espace creatif</h1>
                        <p class="auth-subtitle">
                            Inscris-toi pour enregistrer tes creations, les modifier a volonte et conserver
                            l'historique de tes conversations avec l'IA.
                        </p>
                    </header>
                    <footer class="auth-footer">
                        <p>Deja membre ?</p>
                        <a href="/login" class="auth-footer__link">
                            Se connecter
                        </a>
                    </footer>
            </section>

            <section class="auth-card__main">
                    <div class="mb-8 text-center lg:text-left">
                        <span class="auth-badge">
                            <span class="auth-badge__dot auth-badge__dot--secondary"></span>
                            Inscription
                        </span>
                        <h2 class="auth-heading">
                            Creer un compte
                        </h2>
                        <p class="auth-description">
                            Quelques informations suffisent pour commencer a generer des SVG spectaculaires.
                        </p>
                    </div>

                    <form id="signup-form" class="flex flex-col gap-5" enctype="multipart/form-data">
                        <label class="auth-field">
                            <span class="auth-field__label">Nom affiche</span>
                            <input
                                type="text"
                                name="name"
                                placeholder="Ton nom"
                                required
                                class="input input-bordered w-full h-12 focus:input-secondary"
                            />
                        </label>
                        <label class="auth-field">
                            <span class="auth-field__label">Email</span>
                            <input
                                type="email"
                                name="email"
                                placeholder="ton.email@example.com"
                                required
                                class="input input-bordered w-full h-12 focus:input-secondary"
                            />
                        </label>
                        <label class="auth-field">
                            <span class="auth-field__label">Mot de passe</span>
                            <input
                                type="password"
                                name="password"
                                minlength="8"
                                placeholder="********"
                                required
                                class="input input-bordered w-full h-12 focus:input-secondary"
                            />
                        </label>
                        <label class="auth-field">
                            <span class="auth-field__label">Confirme le mot de passe</span>
                            <input
                                type="password"
                                name="passwordConfirm"
                                minlength="8"
                                placeholder="********"
                                required
                                class="input input-bordered w-full h-12 focus:input-secondary"
                            />
                        </label>
                        <label class="auth-field">
                            <span class="auth-field__label">Image de profil</span>
                            <input
                                type="file"
                                name="avatar"
                                accept="image/*"
                                class="file-input file-input-bordered w-full"
                            />
                            <span class="text-xs text-base-content opacity-60">
                                Image carree conseillee, 3 Mo maximum.
                            </span>
                        </label>

                        <button type="submit" class="auth-submit btn btn-secondary">
                            S'inscrire
                        </button>
                    </form>

                    <p class="auth-secondary-action">
                        Deja inscrit ?
                        <a href="/login" class="auth-secondary-link auth-secondary-link--secondary">Se connecter</a>
                    </p>
                    <p id="status" class="mt-4 text-center text-sm"></p>
            </section>
        </div>
        <style>
            .auth-page {
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 3rem 1.5rem;
                background: radial-gradient(circle at top right, rgba(236, 72, 153, 0.35), transparent 45%), radial-gradient(circle at bottom left, rgba(129, 140, 248, 0.35), transparent 50%), linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(14, 165, 233, 0.1));
                position: relative;
            }
            .auth-overlay {
                position: absolute;
                inset: 0;
                background: url("data:image/svg+xml,%3Csvg width='800' height='800' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%23EC4899' stop-opacity='0.35'/%3E%3Cstop offset='100%25' stop-color='%23816CF8' stop-opacity='0.25'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g)' width='800' height='800'/%3E%3C/svg%3E") center/cover;
                opacity: 0.35;
                filter: blur(40px);
                pointer-events: none;
            }
            .auth-card {
                position: relative;
                width: 100%;
                max-width: 960px;
                background: rgba(255, 255, 255, 0.94);
                backdrop-filter: blur(12px);
                border-radius: 24px;
                border: 1px solid rgba(148, 163, 184, 0.25);
                box-shadow: 0 25px 70px -28px rgba(15, 23, 42, 0.45);
                overflow: hidden;
                display: grid;
                grid-template-columns: minmax(0, 1fr);
            }
            @media (min-width: 1024px) {
                .auth-card {
                    grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
                }
            }
            .auth-card__aside {
                display: none;
                background: linear-gradient(140deg, #ec4899, #a855f7, #4f46e5);
                color: #f8fafc;
                padding: 3rem;
                flex-direction: column;
                justify-content: space-between;
            }
            .auth-card__aside--signup {
                background: linear-gradient(140deg, #ec4899, #8b5cf6, #22d3ee);
            }
            @media (min-width: 1024px) {
                .auth-card__aside {
                    display: flex;
                }
            }
            .auth-eyebrow {
                text-transform: uppercase;
                letter-spacing: 0.35em;
                font-size: 0.75rem;
                opacity: 0.75;
            }
            .auth-title {
                margin-top: 1rem;
                font-size: 2.8rem;
                font-weight: 700;
                line-height: 1.1;
            }
            .auth-subtitle {
                margin-top: 1.25rem;
                font-size: 1.05rem;
                line-height: 1.75;
                opacity: 0.88;
            }
            .auth-footer {
                margin-top: 3rem;
                font-size: 0.95rem;
                opacity: 0.9;
            }
            .auth-footer__link {
                display: inline-flex;
                align-items: center;
                gap: 0.35rem;
                margin-top: 0.75rem;
                padding: 0.65rem 1.15rem;
                border: 1px solid rgba(248, 250, 252, 0.6);
                border-radius: 999px;
                font-weight: 600;
                color: inherit;
                text-decoration: none;
                transition: background 0.2s ease;
            }
            .auth-footer__link:hover {
                background: rgba(248, 250, 252, 0.12);
            }
            .auth-card__main {
                padding: clamp(2.5rem, 4vw, 3.25rem);
                background: rgba(255, 255, 255, 0.92);
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .auth-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.4rem 0.95rem;
                border-radius: 999px;
                background: rgba(226, 232, 240, 0.6);
                font-size: 0.75rem;
                font-weight: 600;
                letter-spacing: 0.05em;
            }
            .auth-badge__dot {
                width: 0.5rem;
                height: 0.5rem;
                border-radius: 999px;
                background: #4f46e5;
                animation: pulse 2s infinite;
            }
            .auth-badge__dot--secondary {
                background: #ec4899;
            }
            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 0.85;
                }
                50% {
                    transform: scale(1.35);
                    opacity: 0.35;
                }
            }
            .auth-heading {
                margin-top: 1.3rem;
                font-size: clamp(2.25rem, 5vw, 2.8rem);
                font-weight: 700;
                color: #0f172a;
            }
            .auth-description {
                margin-top: 0.9rem;
                color: rgba(15, 23, 42, 0.68);
                font-size: 0.95rem;
                line-height: 1.6;
            }
            .auth-field {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .auth-field__label {
                font-weight: 600;
                color: rgba(15, 23, 42, 0.75);
                font-size: 0.9rem;
            }
            .auth-submit {
                margin-top: 0.5rem;
                height: 3rem;
                font-size: 0.95rem;
                letter-spacing: 0.05em;
                border-radius: 0.75rem;
                text-transform: uppercase;
                box-shadow: 0 12px 24px -12px rgba(236, 72, 153, 0.65);
            }
            .auth-submit:hover {
                box-shadow: 0 18px 28px -14px rgba(236, 72, 153, 0.75);
            }
            .auth-secondary-action {
                margin-top: 1.75rem;
                text-align: center;
                font-size: 0.9rem;
                color: rgba(15, 23, 42, 0.6);
            }
            .auth-secondary-link {
                font-weight: 600;
                color: #4f46e5;
                text-decoration: none;
            }
            .auth-secondary-link--secondary {
                color: #ec4899;
            }
            .auth-secondary-link:hover,
            .auth-secondary-link--secondary:hover {
                text-decoration: underline;
            }
        </style>
    </body>
</html>

<script>
    // @ts-nocheck
    localStorage.removeItem('user');
    const form = document.getElementById('signup-form');
    const status = document.getElementById('status');
    const submitButton = form?.querySelector('button[type="submit"]');
    const avatarInput = form?.querySelector('input[name="avatar"]');
    const MAX_AVATAR_SIZE = 3 * 1024 * 1024; // 3 MB

    form?.addEventListener('submit', async (event) => {
        event.preventDefault();
        status.textContent = '';
        status.classList.remove('text-error', 'text-success');

        const formData = new FormData(form);
        const name = String(formData.get('name') || '').trim();
        const email = String(formData.get('email') || '').trim();
        const password = String(formData.get('password') || '');
        const passwordConfirm = String(formData.get('passwordConfirm') || '');
        const avatarFile = avatarInput?.files?.[0] || null;

        if (!name) {
            status.classList.add('text-error');
            status.textContent = 'Merci de renseigner un nom.';
            return;
        }

        if (!email || !password || !passwordConfirm) {
            status.classList.add('text-error');
            status.textContent = 'Merci de remplir tous les champs requis.';
            return;
        }

        if (password !== passwordConfirm) {
            status.classList.add('text-error');
            status.textContent = 'Les mots de passe ne correspondent pas.';
            return;
        }

        if (avatarFile) {
            if (!avatarFile.type.startsWith('image/')) {
                status.classList.add('text-error');
                status.textContent = 'Le fichier choisi doit etre une image.';
                return;
            }
            if (avatarFile.size > MAX_AVATAR_SIZE) {
                status.classList.add('text-error');
                status.textContent = 'Image trop volumineuse (3 Mo maximum).';
                return;
            }
        }

        const payload = new FormData();
        payload.append('name', name);
        payload.append('email', email);
        payload.append('password', password);
        payload.append('passwordConfirm', passwordConfirm);
        if (avatarFile) {
            payload.append('avatar', avatarFile);
        }

        if (submitButton) {
            submitButton.disabled = true;
            submitButton.classList.add('loading');
        }

        try {
            const response = await fetch('/api/signup', {
                method: 'POST',
                body: payload,
            });
            const data = await response.json().catch(() => ({}));

            if (response.ok && data?.success) {
                status.classList.add('text-success');
                status.textContent = 'Compte cree avec succes. Redirection...';
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1200);
            } else {
                status.classList.add('text-error');
                status.textContent = data?.error || 'Creation du compte impossible.';
            }
        } catch (error) {
            console.error('Signup failed', error);
            status.classList.remove('text-success');
            status.classList.add('text-error');
            status.textContent = 'Erreur inattendue lors de la creation du compte.';
        } finally {
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
            }
        }
    });
</script>

---
import '../styles/global.css';
import { ui } from '../i18n/ui.js';
import pb from '../utils/pb.js';

const localLocale =
  Astro.locals.lang === 'fr' || Astro.locals.lang === 'en'
    ? Astro.locals.lang
    : 'en';
const { title, locale: layoutLocale } = Astro.props;
const locale =
  layoutLocale === 'fr' || layoutLocale === 'en' ? layoutLocale : localLocale;
const pageTitle = title ?? ui[locale].meta.title;
const user = Astro.locals.user;
const userDisplayName =
  (user?.name || '').trim() ||
  (user?.username || '').trim() ||
  (user?.email ? user.email.split('@')[0] : '');
let avatarUrl = '';
if (user?.avatar) {
  try {
    avatarUrl = pb.files.getUrl(user, user.avatar, { thumb: '80x80' });
  } catch (error) {
    console.warn('Failed to resolve avatar url', error);
  }
}
const initials = (userDisplayName || 'U')
  .split(/\s+/)
  .map((part) => part?.[0]?.toUpperCase())
  .filter(Boolean)
  .slice(0, 2)
  .join('') || 'U';
---

<!doctype html>
<html lang={locale} data-theme="light" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
  </head>
  <body
    class="min-h-full bg-gradient-to-br from-primary/15 via-base-200 to-secondary/20 text-base-content"
    data-user-id={user?.id ?? ""}
  >
    <div class="relative min-h-full flex flex-col overflow-hidden">
      <div
        aria-hidden="true"
        class="pointer-events-none absolute inset-x-0 top-[-20rem] h-[32rem] bg-gradient-to-b from-primary/30 via-transparent to-transparent blur-3xl opacity-40"
      ></div>
      <header class="w-full pt-6 pb-4">
        <div
          class="max-w-6xl mx-auto px-4 flex items-center justify-between gap-4 flex-wrap rounded-2xl border border-white/30 bg-white/70 shadow-2xl backdrop-blur-xl"
        >
          <nav class="flex items-center gap-4 text-sm font-semibold uppercase tracking-wide text-base-content/80">
            <a href="/" class="px-3 py-4 hover:text-primary transition-colors">{ui[locale].nav.home}</a>
            <a href="/generator" class="px-3 py-4 hover:text-primary transition-colors">
              {ui[locale].nav.generator}
            </a>
            <a href="/gallery" class="px-3 py-4 hover:text-primary transition-colors">
              {ui[locale].nav.myGallery}
            </a>
            <a href="/gallery/public" class="px-3 py-4 hover:text-primary transition-colors">
              {ui[locale].nav.publicGallery}
            </a>
          </nav>
          <div class="flex items-center gap-4 flex-wrap pr-4 py-2">
            {!user && (
              <a href="/login" class="btn btn-sm btn-outline btn-accent">
                {ui[locale].nav.loginButton}
              </a>
            )}
            {user && (
              <a
                href="/profile"
                class="btn btn-sm btn-ghost gap-2 hover:bg-primary/10 transition-colors"
              >
                <span class="hidden sm:inline">{ui[locale].nav.profile}</span>
                {avatarUrl ? (
                  <img
                    src={avatarUrl}
                    alt={userDisplayName || 'Avatar'}
                    class="h-8 w-8 rounded-full object-cover border border-base-200"
                  />
                ) : (
                  <span
                    class="avatar placeholder h-8 w-8 rounded-full bg-gradient-to-br from-primary to-secondary text-primary-content text-sm font-semibold flex items-center justify-center"
                  >
                    {initials}
                  </span>
                )}
              </a>
            )}
            {user && (
              <form method="POST" action="/api/logout" class="m-0 p-0">
                <button type="submit" class="btn btn-sm btn-primary btn-outline">
                  {ui[locale].nav.logoutButton}
                </button>
              </form>
            )}
            <form
              method="POST"
              action={Astro.url.pathname}
              class="flex items-center gap-2 bg-base-100/60 px-3 py-2 rounded-xl border border-base-200/60"
            >
              <label class="text-sm font-semibold" for="language-select">
                {ui[locale].nav.language}
              </label>
              <select
                id="language-select"
                name="language"
                class="select select-bordered select-sm"
                onchange="this.form.submit()"
              >
                <option value="en" selected={locale === 'en'}>
                  {ui[locale].nav.english}
                </option>
                <option value="fr" selected={locale === 'fr'}>
                  {ui[locale].nav.french}
                </option>
              </select>
            </form>
          </div>
        </div>
      </header>
      <main class="flex-1 min-h-0 relative z-10">
        <slot />
      </main>
    </div>
  </body>
</html>
